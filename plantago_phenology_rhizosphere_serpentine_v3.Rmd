---
title: "P. erecta phenology"
author: "Alexandria igwe"
date: "5/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
--- ORIGINAL CODE ---
#Load libraries
```{r}
library(phyloseq)
library(decontam)
library(dplyr)
library(RColorBrewer)
library(ggpubr)
library(vegan)
library(ggplot2)
library(lubridate)
library(lme4)
library(survival)
library(survminer)
library(DESeq2)
library(car)
library(emmeans)
library(viridis)
library(patchwork)
```
#Microbial Community Analysis
##Import data
```{r import data, include=FALSE}
otu <- readRDS("~/Desktop/R/serpnon_timeseries/input/serpnon_timeseries_otu_dada.rds")
tax <- readRDS("~/Desktop/R/serpnon_timeseries/input/serpnon_timeseries_silva.rds")
fitGTR <- readRDS("~/Desktop/R/serpnon_timeseries/input/seqtab.nochim_tree.RDS")
ps.metadata <- read.csv("~/Desktop/R/serpnon_timeseries/input/timeseries_metadata_phyloseq.csv",row.names=2)
```
##Create phyloseq objects
```{r otu table, include=FALSE}
OTU = otu_table(otu, taxa_are_rows=FALSE)
TAX = tax_table(as.matrix(tax))
TREE = phy_tree(fitGTR$tree)
META <- sample_data(ps.metadata)
ps = phyloseq(OTU, TAX, TREE, META)
ps
```
##Rarefaction curves by soil type (Supplemental Figures 1-6)
###A
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.A<- ps %>%
  subset_samples(
    soil_let == "A"
    )

timeseries.otu.A <- as(otu_table(ps.A), "matrix")
Rarecurve.A <- rarecurve((timeseries.otu.A), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
Rarecurve.A
```
###B
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.B<- ps %>%
  subset_samples(
    soil_let == "B"
    )

timeseries.otu.B <- as(otu_table(ps.B), "matrix")
Rarecurve.B <- rarecurve((timeseries.otu.B), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```
###C
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.C<- ps %>%
  subset_samples(
    soil_let == "C"
    )

timeseries.otu.C <- as(otu_table(ps.C), "matrix")
Rarecurve.C <- rarecurve((timeseries.otu.C), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```
###D
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.D<- ps %>%
  subset_samples(
    soil_let == "D"
    )

timeseries.otu.D <- as(otu_table(ps.D), "matrix")
Rarecurve.D <- rarecurve((timeseries.otu.D), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```
###E
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.E<- ps %>%
  subset_samples(
    soil_let == "E"
    )

timeseries.otu.E <- as(otu_table(ps.E), "matrix")
Rarecurve.E <- rarecurve((timeseries.otu.E), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```
###F
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.F<- ps %>%
  subset_samples(
    soil_let == "F"
    )

timeseries.otu.F <- as(otu_table(ps.F), "matrix")
Rarecurve.F <- rarecurve((timeseries.otu.F), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```

##Remove mitochondria and chloroplast
```{r remove mitochondria, include=FALSE}
ps.bact <- ps %>%
  subset_taxa(
    Kingdom == "Bacteria" &
    Family  != "Mitochondria" &
    Class   != "Chloroplast"
  )
ps.bact
```
##Change taxa names to Seq #
```{r}
taxa_names(ps.bact) <- paste0("Seq", seq(ntaxa(ps.bact)))
dim(otu_table(ps.bact))
```
##Decontam
```{r}
ps.bact@sam_data$sample_or_control<-ps.bact@sam_data$soil_let
ps.bact@sam_data$sample_or_control<-as.character(ps.bact@sam_data$sample_or_control)
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="A"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="B"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="C"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="D"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="E"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="F"]<-"sample"
ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control!="CON"]<-"sample"
ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="CON"]<-"control"
ps.bact@sam_data$sample_or_control<-as.factor(ps.bact@sam_data$sample_or_control)
ps.bact@sam_data$sample_or_control
```
```{r}
df <- as.data.frame(sample_data(ps.bact)) # Put sample_data into a ggplot-friendly data.frame
df$LibrarySize <- sample_sums(ps.bact)
df <- df[order(df$LibrarySize),]
df$Index <- seq(nrow(df))
ggplot(data=df, aes(x=Index, y=LibrarySize, color=sample_or_control)) + geom_point()
```
```{r}
sample_data(ps.bact)$is.neg <- sample_data(ps.bact)$sample_or_control == "control"
contamdf.prev <- isContaminant(ps.bact, method="prevalence", neg="is.neg", threshold = 0.025, batch=ps.bact@sam_data$date.dna)
table(contamdf.prev$contaminant)
head(which(contamdf.prev$contaminant))
contamdf.prev_decontam <- subset(contamdf.prev, contamdf.prev$contaminant=="FALSE")
ps.bact.decontam <- subset_taxa(ps.bact, taxa_names(ps.bact)%in%rownames(contamdf.prev_decontam))
ps.bact.decontam
contamdf.prev_contam <- subset(contamdf.prev, contamdf.prev$contaminant=="TRUE")
ps.bact.contam <- subset_taxa(ps.bact, taxa_names(ps.bact)%in%rownames(contamdf.prev_contam))
ps.bact.contam
```
```{r}
# Make phyloseq object of presence-absence in negative controls and true samples
ps.bact.pa <- transform_sample_counts(ps.bact, function(abund) 1*(abund>0))
ps.bact.pa.neg <- prune_samples(sample_data(ps.bact.pa)$sample_or_control == "control", ps.bact.pa)
ps.bact.pa.pos <- prune_samples(sample_data(ps.bact.pa)$sample_or_control == "sample", ps.bact.pa)
# Make data.frame of prevalence in positive and negative samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.bact.pa.pos), pa.neg=taxa_sums(ps.bact.pa.neg),
                      contaminant=contamdf.prev$contaminant)
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color=contaminant)) + geom_point() +
  xlab("Prevalence (Negative Controls)") + ylab("Prevalence (True Samples)")
```
##Normalize sequences for bray-curtis
```{r}
#for bray-curtis
ps.bact.decontam_prop <- transform_sample_counts(ps.bact.decontam, function(x) x/sum(x))
ps.bact.decontam_prop <- subset_taxa(ps.bact.decontam_prop,taxa_sums(ps.bact.decontam_prop)>0)
ps.bact.decontam_prop
dim(otu_table(ps.bact.decontam_prop))
```
##labels
```{r}
microbe_labels <- c("nonserpentine"="NS Microbes", "serpentine"="S Microbes")
soil_let_labels <- c("A"="S+Sm", "B"="NS+NSm", "C"="S+NSm", "D"="NS+Sm", "E"="NS+Sm+Ni", "F"="NS+Sm+Drought")
```
##Subset samples
###A-F soil types
```{r, include=FALSE}
ps.bact.decontam.af <- ps.bact.decontam %>%
  subset_samples(
    soil_let == "A" |
    soil_let == "B" |
    soil_let == "C" |
    soil_let == "D" |
    soil_let == "E" |
    soil_let == "F" |
    soil_let != "CON")

ps.bact.decontam.af <- ps.bact.decontam.af %>%
  subset_samples(
    pds=="0" |
    pds=="1" |
    pds=="2" |
    pds=="3" |
    pds=="4" )

ps.bact.decontam.af
```
```{r}
ps.bact.decontam.af_prop <- ps.bact.decontam_prop %>%
  subset_samples(
    soil_let == "A" |
    soil_let == "B" |
    soil_let == "C" |
    soil_let == "D" |
    soil_let == "E" |
    soil_let == "F" |
    soil_let != "CON")

ps.bact.decontam.af_prop <- ps.bact.decontam.af_prop %>%
  subset_samples(
    pds=="0" |
    pds=="1" |
    pds=="2" |
    pds=="3" |
    pds=="4" )

ps.bact.decontam.af_prop
```
##Figure 1
###What is the relative abundance of each phylum within the different samples?
```{r}
#wrangle data
ps.bact.decontam_phylum <- ps.bact.decontam.af %>%
  tax_glom(taxrank = "Phylum") %>%                     # agglomerate at phylum level
 transform_sample_counts(function(x) {x/sum(x)} ) %>% # Transform to rel. abundance
  psmelt() %>%                                         # Melt to long format
  filter(Abundance > 0.02) %>%                         # Filter out low abundance taxa
  arrange(Phylum)
ps.bact.decontam_phylum
```
```{r}
#abundance table
sd_phylum <- ps.bact.decontam_phylum %>% group_by(soil_stress,microbe_type,pds,Phylum) %>% dplyr::summarise(mean(Abundance, na.rm = TRUE))
sd_phylum
```
###What is the alpha diversity?
```{r}
#table of richness
sg.richness <- estimate_richness(ps.bact.decontam.af, measures=c("Shannon"))
sg.richness$Shannon
sg.richness$ID <- row.names(sg.richness)
View(sg.richness)
timeseries.af.df <- as(sample_data(ps.bact.decontam.af), "data.frame")
timeseries.af.df$ID <- row.names(timeseries.af.df)
timeseries.df.richness <- merge(timeseries.af.df,sg.richness,by="ID")
row.names(timeseries.df.richness)<-timeseries.df.richness$ID

#abundance table
sd_richness <- timeseries.df.richness %>% group_by(soil_stress,microbe_type,pds) %>% dplyr::summarise(mean(Shannon, na.rm = TRUE))
sd_richness
```
```{r}
#statistical analysis of shannon
field.fit.shannon <- lm(estimate_richness(ps.bact.decontam.af)$Shannon ~ soil_stress*microbe_type*pds+tray, data=as(sample_data(ps.bact.decontam.af), "data.frame"))
summary(aov(field.fit.shannon))
TukeyHSD(aov(field.fit.shannon))
```
###Figure 1 - relative abundance + richness
```{r}
ps.bact.decontam_phylum$soil_stress_new<-factor(ps.bact.decontam_phylum$soil_stress, levels=c("S","NS","NS+Drought","NS+Ni"))

ps.bact.decontam.af@sam_data$soil_stress_new<-factor(ps.bact.decontam.af@sam_data$soil_stress, levels=c("S","NS","NS+Drought","NS+Ni"))

# Define the number of colors you want
nb.cols <- length(unique(ps.bact.decontam_phylum$Phylum))
mycolors <- colorRampPalette(brewer.pal(11, "Spectral"))(nb.cols)

ps.bact.decontam_phylum_bar<-ggplot(ps.bact.decontam_phylum, aes(x = pds, y = Abundance, fill = Phylum)) + theme_bw() + facet_grid(microbe_type~soil_stress_new, labeller=labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering")) +
  geom_bar(stat="identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  #fill=mycolors(nb.cols) +
  scale_fill_manual(values=mycolors) +
  theme(text = element_text(size=16)) +
  ylab ("Relateve Abundance (Phyla > 2%)") +
  xlab ("Plant Developmental Phase") +
  theme(legend.position="bottom",
        axis.text.x = element_text(angle=90, hjust=0.5, vjust=0.5)) +
  guides(fill=guide_legend(legend.position="bottom", nrow=4))

sg_richness_plot <- plot_richness(ps.bact.decontam.af, x="pds", measures=c("Shannon")) +  theme_bw() + 
  facet_grid(microbe_type~soil_stress_new, labeller=labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering")) +
  geom_boxplot() +
  xlab ("Plant Developmental Phase") +
  scale_color_viridis(discrete=TRUE, option="inferno") + 
  theme(text = element_text(size=16), axis.text.x = element_text(angle=90, hjust=1, vjust=0.9), legend.title=element_blank())
sg_richness_plot$layers <- sg_richness_plot$layers[-1]

fig.1<-ggarrange(ps.bact.decontam_phylum_bar,sg_richness_plot, labels="auto", nrow=1,  widths = c(1.25, 1))
fig.1
#ggsave("/Users/anigwe/Desktop/strep_figures/figure1.tiff", height=180, width=350, units='mm', dpi=200)
```
##Figure 2
###What is the beta diversity? - bray
```{r}
#stats bray
serpnon.timeseries.af_bray <- phyloseq::distance(ps.bact.decontam.af_prop, method="bray")
#summary(strep.bray)
sampledf.strep <- data.frame(sample_data(ps.bact.decontam.af_prop))
adonis.serpnon.timeseries.af.bray <- adonis(serpnon.timeseries.af_bray ~ soil_stress*microbe_type*pds+tray, data = sampledf.strep)
adonis.serpnon.timeseries.af.bray
#betadisper
beta.serpnon.timeseries.af.bray_sc <- betadisper(serpnon.timeseries.af_bray, sampledf.strep$soil_stress, type="centroid")
permutest(beta.serpnon.timeseries.af.bray_sc)
boxplot(beta.serpnon.timeseries.af.bray_sc)
TukeyHSD(beta.serpnon.timeseries.af.bray_sc)

beta.serpnon.timeseries.af.bray <- betadisper(serpnon.timeseries.af_bray, sampledf.strep$pds, type="centroid")
permutest(beta.serpnon.timeseries.af.bray)
boxplot(beta.serpnon.timeseries.af.bray)
TukeyHSD(beta.serpnon.timeseries.af.bray)

beta.serpnon.timeseries.af.bray_ms <- betadisper(serpnon.timeseries.af_bray, sampledf.strep$microbe_type, type="centroid")
permutest(beta.serpnon.timeseries.af.bray_ms)
boxplot(beta.serpnon.timeseries.af.bray_ms)
TukeyHSD(beta.serpnon.timeseries.af.bray_ms)
```
###Figure 2 - Bray-Curtis Dissimilarity
```{r}
ps.bact.decontam.af_prop@sam_data$soil_stress_new<-factor(ps.bact.decontam.af_prop@sam_data$soil_stress, levels=c("S","NS","NS+Drought","NS+Ni"))
#ordination
ord.pcoa.bray <- ordinate(ps.bact.decontam.af_prop, method="PCoA", distance="bray")
#Figure 4
bg.facet <-plot_ordination(ps.bact.decontam.af_prop, ord.pcoa.bray, color="pds") +
  scale_color_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering")) +
  #scale_color_manual(breaks=c("A","B","C","D","E","F"),
                    # values=c("#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00"), labels=soil_let_labels) +
  facet_grid(microbe_type~soil_stress_new, labeller=labeller(microbe_type = microbe_labels)) +
  theme_bw() + theme(text = element_text(size=20)) +
  geom_point(size=5)+
  theme(legend.text = element_text(size = 20)) + 
  guides(color=guide_legend(title="Plant Developmental Phase")) 
  #labs(title="PCoA of Bray-Curtis Dissimilarity")
#+ scale_color_viridis(option="inferno")
bg.facet
#ggsave("/Users/anigwe/Desktop/feature_image_test.png", height=223, width=400, units='mm', dpi=400)
```
##Figure 5, Supplemental Figure 7, Supplemental Figure 8
###Are there differentially abundant microbes? - DESeq2?
```{r}
#ps.bact.decontam.af_phyla<-tax_glom(ps.bact.decontam.af, "Phylum")
#ps.bact.decontam.af_family<-tax_glom(ps.bact.decontam.af, "Family")
#ps.bact.decontam.af_genus<-tax_glom(ps.bact.decontam.af, "Genus")
#ps.bact.decontam.af_asv<-ps.bact.decontam.af
```
```{r}
ps.bact.decontam.af.4 <- ps.bact.decontam.af %>%
  subset_samples(
    pds=="4")

ps.bact.decontam.af.4

ps.bact.decontam.ad <- ps.bact.decontam %>%
  subset_samples(
    soil_let == "A" |
    soil_let == "B" |
    soil_let == "C" |
    soil_let == "D" )

ps.bact.decontam.ad <- ps.bact.decontam.ad %>%
  subset_samples(pds!="5")

ps.bact.decontam.ad
```
###DESeq2 Code
```{r}
#analysis of all soil treatments and plant developmental stages 1 and 4
library(DESeq2)
set.seed(711)
packageVersion("DESeq2")
diagdds.asv.af.1_4_soil_let = phyloseq_to_deseq2(ps.bact.decontam.af.4, ~soil_let)
diagdds.asv.af.1_4_soil_let$soil_stress <- relevel(diagdds.asv.af.1_4_soil_let$soil_stress, ref = "S")
gm_mean.field.asv_soil_let = function(x, na.rm=TRUE){ exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))}
geoMeans.field.asv_soil_let = apply(counts(diagdds.asv.af.1_4_soil_let), 1, gm_mean.field.asv_soil_let)
diagdds.asv.af.1_4_soil_let = estimateSizeFactors(diagdds.asv.af.1_4_soil_let, geoMeans = geoMeans.field.asv_soil_let)
diagdds.asv.af.1_4_soil_let = DESeq(diagdds.asv.af.1_4_soil_let, betaPrior = FALSE, test="Wald", fitType="parametric")
#If "Error in `rownames<-`(`*tmp*`, value = c("sp1", "sp0")) : length of 'dimnames' [1] not equal to array extent" appears, increase alpha to .90 to determine if there is a lack of differential OTUs at alpha = 0.01 or if there is a problem with the code.
resultsNames(diagdds.asv.af.1_4_soil_let)
res.asv.af.1_4_soil_let = results(diagdds.asv.af.1_4_soil_let, cooksCutoff = FALSE)
alpha = 0.01
sigtab.asv.af.1_4_soil_let = res.asv.af.1_4_soil_let[which(res.asv.af.1_4_soil_let$padj < alpha), ]
sigtab.asv.af.1_4_soil_let = cbind(as(sigtab.asv.af.1_4_soil_let, "data.frame"), as(tax_table(ps.bact.decontam.af)[rownames(sigtab.asv.af.1_4_soil_let), ], "matrix"))
sigtab.asv.af.1_4_soil_let = as.data.frame(sigtab.asv.af.1_4_soil_let)
sigtab.asv.af.1_4_soil_let$asv_soil_let<-row.names(sigtab.asv.af.1_4_soil_let)
head(sigtab.asv.af.1_4_soil_let)
subset.asv.af.1_4_soil_let <- subset_taxa(ps.bact.decontam.af.4, taxa_names(ps.bact.decontam.af.4)%in%rownames(sigtab.asv.af.1_4_soil_let))
subset.asv.af.1_4_soil_let
dat.asv.af.1_4_soil_let <- psmelt(subset.asv.af.1_4_soil_let) # create data frame
#export differential asv_soil_lets
write.csv(dat.asv.af.1_4_soil_let, file="/Users/anigwe/Desktop/serp_timeseries_figures/DESeq2_asv.af.4_soil_let_decontam.csv")
```
```{r}
#analysis of plant developmental stages 1,2,3,4 of soil treatments A,B,C,D (excludes E,F)
library(DESeq2)
set.seed(711)
packageVersion("DESeq2")
diagdds.asv.ad_soil_let = phyloseq_to_deseq2(ps.bact.decontam.ad, ~soil_let)
diagdds.asv.ad_soil_let$soil_stress <- relevel(diagdds.asv.ad_soil_let$soil_stress, ref = "S")
gm_mean.field.asv_soil_let = function(x, na.rm=TRUE){ exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))}
geoMeans.field.asv_soil_let = apply(counts(diagdds.asv.ad_soil_let), 1, gm_mean.field.asv_soil_let)
diagdds.asv.ad_soil_let = estimateSizeFactors(diagdds.asv.ad_soil_let, geoMeans = geoMeans.field.asv_soil_let)
diagdds.asv.ad_soil_let = DESeq(diagdds.asv.ad_soil_let, betaPrior = FALSE, test="Wald", fitType="parametric")
#If "Error in `rownames<-`(`*tmp*`, value = c("sp1", "sp0")) : length of 'dimnames' [1] not equal to array extent" appears, increase alpha to .90 to determine if there is a lack of differential OTUs at alpha = 0.01 or if there is a problem with the code.
resultsNames(diagdds.asv.ad_soil_let)
res.asv.ad_soil_let = results(diagdds.asv.ad_soil_let, cooksCutoff = FALSE)
alpha = 0.01
sigtab.asv.ad_soil_let = res.asv.ad_soil_let[which(res.asv.ad_soil_let$padj < alpha), ]
sigtab.asv.ad_soil_let = cbind(as(sigtab.asv.ad_soil_let, "data.frame"), as(tax_table(ps.bact.decontam.af)[rownames(sigtab.asv.ad_soil_let), ], "matrix"))
sigtab.asv.ad_soil_let = as.data.frame(sigtab.asv.ad_soil_let)
sigtab.asv.ad_soil_let$asv_soil_let<-row.names(sigtab.asv.ad_soil_let)
head(sigtab.asv.ad_soil_let)
subset.asv.ad_soil_let <- subset_taxa(ps.bact.decontam.ad, taxa_names(ps.bact.decontam.ad)%in%rownames(sigtab.asv.ad_soil_let))
subset.asv.ad_soil_let
dat.asv.ad_soil_let <- psmelt(subset.asv.ad_soil_let) # create data frame
#export differential asv_soil_lets
#write.csv(dat.asv.ad_soil_let, file="/Users/anigwe/Desktop/serp_timeseries_figures/DESeq2_asv.ad_soil_let_decontam.csv")
```
```{r}
#analysis of plant developmental stages 1,2,3,4 of soil treatments A,B,C,D (excludes E,F)
library(DESeq2)
set.seed(711)
packageVersion("DESeq2")
diagdds.asv.af_pds = phyloseq_to_deseq2(ps.bact.decontam.af, ~pds)
diagdds.asv.af_pds$soil_stress <- relevel(diagdds.asv.af_pds$soil_stress, ref = "S")
gm_mean.field.af_pds = function(x, na.rm=TRUE){ exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))}
geoMeans.field.af_pds = apply(counts(diagdds.asv.af_pds), 1, gm_mean.field.af_pds)
diagdds.asv.af_pds = estimateSizeFactors(diagdds.asv.af_pds, geoMeans = geoMeans.field.af_pds)
diagdds.asv.af_pds = DESeq(diagdds.asv.af_pds, betaPrior = FALSE, test="Wald", fitType="parametric")
#If "Error in `rownames<-`(`*tmp*`, value = c("sp1", "sp0")) : length of 'dimnames' [1] not equal to array extent" appears, increase alpha to .90 to determine if there is a lack of differential OTUs at alpha = 0.01 or if there is a problem with the code.
resultsNames(diagdds.asv.af_pds)
res.asv.af_pds = results(diagdds.asv.af_pds, cooksCutoff = FALSE)
alpha = 0.01
sigtab.asv.af_pds = res.asv.af_pds[which(res.asv.af_pds$padj < alpha), ]
sigtab.asv.af_pds = cbind(as(sigtab.asv.af_pds, "data.frame"), as(tax_table(ps.bact.decontam.af)[rownames(sigtab.asv.af_pds), ], "matrix"))
sigtab.asv.af_pds = as.data.frame(sigtab.asv.af_pds)
sigtab.asv.af_pds$asv_soil_let<-row.names(sigtab.asv.af_pds)
head(sigtab.asv.af_pds)
subset.asv.af_pds <- subset_taxa(ps.bact.decontam.af, taxa_names(ps.bact.decontam.af)%in%rownames(sigtab.asv.af_pds))
subset.asv.af_pds
dat.asv.af_pds <- psmelt(subset.asv.af_pds) # create data frame
#export differential asv_soil_lets
#write.csv(dat.asv.af_pds,file="/Users/anigwe/Desktop/serp_timeseries_figures/DESeq2_asv.af_pds_decontam.csv")
```
###Figures
```{r}
#Figure 5; x=Genus,facet_wrap=Phylum,fill=soil_let2
str(dat.asv.af.1_4_soil_let)
dat_af.1_4_soil_let <- dat.asv.af.1_4_soil_let %>% group_by(Phylum,Genus,soil_let) %>%
  dplyr::summarise(
  n=sum(!is.na(Abundance)),
  sd(Abundance , na.rm = TRUE),
  mean(Abundance , na.rm = TRUE),
  min(Abundance , na.rm = TRUE),
  max(Abundance , na.rm = TRUE),
  var(Abundance , na.rm = TRUE),
  se = sd(Abundance, na.rm=T)/sqrt(sum(!is.na(Abundance))))
colnames(dat_af.1_4_soil_let)<-c("Phylum","Genus","soil_let","n","sd","mean","min","max","var","se")
dat_af.1_4_soil_let
dat_af.1_4_soil_let.df<-as.data.frame(dat_af.1_4_soil_let)
dat_af.1_4_soil_let.df<- subset(dat_af.1_4_soil_let.df, mean!=0)

str(dat.asv.ad_soil_let)
dat_ad_soil_let <- dat.asv.ad_soil_let %>% group_by(Phylum,Genus,soil_let) %>%
  dplyr::summarise(
  n=sum(!is.na(Abundance)),
  sd(Abundance , na.rm = TRUE),
  mean(Abundance , na.rm = TRUE),
  min(Abundance , na.rm = TRUE),
  max(Abundance , na.rm = TRUE),
  var(Abundance , na.rm = TRUE),
  se = sd(Abundance, na.rm=T)/sqrt(sum(!is.na(Abundance))))
colnames(dat_ad_soil_let)<-c("Phylum","Genus","soil_let","n","sd","mean","min","max","var","se")
dat_ad_soil_let
dat_ad_soil_let.df<-as.data.frame(dat_ad_soil_let)
dat_ad_soil_let.df<- subset(dat_ad_soil_let.df, mean!=0)

#https://stackoverflow.com/questions/12805964/remove-duplicates-keeping-entry-with-largest-absolute-value
dat_af.4_ad<-rbind(dat_af.1_4_soil_let.df,dat_ad_soil_let.df)
dat_af.4_ad$soil_let2 <- dat_af.4_ad$soil_let
dat_af.4_ad$soil_let2<-as.character(dat_af.4_ad$soil_let2)
dat_af.4_ad$soil_let2[dat_af.4_ad$soil_let2=="A"]<-"S"
dat_af.4_ad$soil_let2[dat_af.4_ad$soil_let2=="B"]<-"NS"
dat_af.4_ad$soil_let2[dat_af.4_ad$soil_let2=="C"]<-"S+NSm"
dat_af.4_ad$soil_let2[dat_af.4_ad$soil_let2=="D"]<-"NS+Sm"
dat_af.4_ad$soil_let2[dat_af.4_ad$soil_let2=="E"]<-"NS+Sm+Ni"
dat_af.4_ad$soil_let2[dat_af.4_ad$soil_let2=="F"]<-"NS+Sm+Drought"
dat_af.4_ad$soil_let2<-as.factor(dat_af.4_ad$soil_let2)
#create new column with Genus and soil_let treatments so that duplicates can be removed
dat_af.4_ad$Genussoil_let<-paste(dat_af.4_ad$Genus,dat_af.4_ad$soil_let)
#sort by Genus and soil_let and reverse of abs(value)
dat_af.4_ad_order<-dat_af.4_ad[order(dat_af.4_ad$Genussoil_let,-abs(dat_af.4_ad$n)),]
# take the first row within each id
dat_af.4_ad_order_unique<-dat_af.4_ad_order[!duplicated(dat_af.4_ad_order$Genussoil_let), ]        
View(dat_af.4_ad_order_unique)

dat_af.4_ad.plot<-ggplot(data=dat_af.4_ad_order_unique, aes(x=Genus, y=mean, fill=soil_let2)) + theme_bw() +
  geom_bar(stat="identity", position="dodge") +
geom_errorbar(aes(x=Genus, ymin=mean-se, ymax=mean+se),position="dodge", colour="black") +
  facet_grid(soil_let~Phylum, scales="free", labeller = labeller(microbe_type = microbe_labels)) +
  scale_fill_brewer(palette="Spectral") +
  theme(text = element_text(size=10), legend.position="bottom",
        strip.text.y = element_text(face = "italic"),
        axis.text.x = element_text(angle = 90lii)) +
  #scale_x_discrete(labels = c("A"="S", "B"="NS", "C"="S+NSm", "D"="NS+Sm", "E"="NS+Sm+Ni", "F"="NS+Sm+Drought")) +
  xlab("Genus") +
  ylab("Average Read Abundance") +
  guides(fill=guide_legend(title="Soil Treatment"))
dat_af.4_ad.plot
```
```{r}
#Supplemental Figure 7; x=otu, facet_grid=Phylum~microbe_type, fill=soil_stress
str(dat.asv.af.1_4_soil_let)
dat_asv.af.1_4_soil_let <- dat.asv.af.1_4_soil_let %>% group_by(Phylum,Genus,OTU,soil_stress,microbe_type) %>%
  dplyr::summarise(
  n=sum(!is.na(Abundance)),
  sd(Abundance , na.rm = TRUE),
  mean(Abundance , na.rm = TRUE),
  min(Abundance , na.rm = TRUE),
  max(Abundance , na.rm = TRUE),
  var(Abundance , na.rm = TRUE),
  se = sd(Abundance, na.rm=T)/sqrt(sum(!is.na(Abundance))))
colnames(dat_asv.af.1_4_soil_let)<-c("Phylum","Genus","OTU","soil_stress","microbe_type","n","sd","mean","min","max","var","se")
dat_asv.af.1_4_soil_let
dat_asv.af.1_4_soil_let.df<-as.data.frame(dat_asv.af.1_4_soil_let)
dat_asv.af.1_4_soil_let.df<- subset(dat_asv.af.1_4_soil_let.df, mean!=0)

str(dat.asv.ad_soil_let)
dat_asv.ad_soil_let <- dat.asv.ad_soil_let %>% group_by(Phylum,Genus,OTU,soil_stress,microbe_type) %>%
  dplyr::summarise(
  n=sum(!is.na(Abundance)),
  sd(Abundance , na.rm = TRUE),
  mean(Abundance , na.rm = TRUE),
  min(Abundance , na.rm = TRUE),
  max(Abundance , na.rm = TRUE),
  var(Abundance , na.rm = TRUE),
  se = sd(Abundance, na.rm=T)/sqrt(sum(!is.na(Abundance))))
colnames(dat_asv.ad_soil_let)<-c("Phylum","Genus","OTU","soil_stress","microbe_type","n","sd","mean","min","max","var","se")
dat_asv.ad_soil_let
dat_asv.ad_soil_let.df<-as.data.frame(dat_asv.ad_soil_let)
dat_asv.ad_soil_let.df<- subset(dat_asv.ad_soil_let.df, mean!=0)

#https://stackoverflow.com/questions/12805964/remove-duplicates-keeping-entry-with-largest-absolute-value
dat_af.4_ad_otu<-rbind(dat_asv.af.1_4_soil_let.df,dat_asv.ad_soil_let.df)
#create new column with Genus and soil_let treatments so that duplicates can be removed
dat_af.4_ad_otu$Genussoil_stress<-paste(dat_af.4_ad_otu$Genus,dat_af.4_ad_otu$soil_stress)
#sort by Genus and soil_let and reverse of abs(value)
dat_af.4_ad_otu_order<-dat_af.4_ad_otu[order(dat_af.4_ad_otu$Genussoil_stress,-abs(dat_af.4_ad_otu$n)),]
# take the first row within each id
dat_af.4_ad_otu_order_unique<-dat_af.4_ad_otu_order[!duplicated(dat_af.4_ad_otu_order$Genussoil_stress), ]        
View(dat_af.4_ad_otu_order_unique)

dat_af.4_ad_otu.plot<-ggplot(data=dat_af.4_ad_otu_order_unique, aes(x=OTU, y=mean, fill=soil_stress)) + theme_bw() +
  geom_bar(stat="identity", position="dodge") +
geom_errorbar(aes(x=OTU, ymin=mean-se, ymax=mean+se),position="dodge", colour="black") +
  facet_grid(microbe_type~Phylum, scales="free", labeller = labeller(microbe_type = microbe_labels)) +
#  scale_fill_brewer(palette="Spectral") +
  theme(text = element_text(size=10), legend.position="bottom",
        strip.text.y = element_text(face = "italic"),
        axis.text.x = element_text(angle = 90)) +
  #scale_x_discrete(labels = c("A"="S", "B"="NS", "C"="S+NSm", "D"="NS+Sm", "E"="NS+Sm+Ni", "F"="NS+Sm+Drought")) +
  xlab("ASV") +
  ylab("Average Read Abundance") +
  guides(fill=guide_legend(title="Soil Type"))
dat_af.4_ad_otu.plot
```
```{r}
#Supplemental Figure 8; x=pds, facet_grid=soil_let2~Phylum~Genus~OTU, fill=Phylum
str(dat.asv.af_pds)
dat_pds.af.pds <- dat.asv.af_pds %>% group_by(Phylum,Genus,soil_let,pds) %>%
  dplyr::summarise(
  n=sum(!is.na(Abundance)),
  sd(Abundance , na.rm = TRUE),
  mean(Abundance , na.rm = TRUE),
  min(Abundance , na.rm = TRUE),
  max(Abundance , na.rm = TRUE),
  var(Abundance , na.rm = TRUE),
  se = sd(Abundance, na.rm=T)/sqrt(sum(!is.na(Abundance))))
colnames(dat_pds.af.pds)<-c("Phylum","Genus","soil_let","pds","n","sd","mean","min","max","var","se")
dat_pds.af.pds
dat_pds.af.pds.df<-as.data.frame(dat_pds.af.pds)
dat_pds.af.pds.df<- subset(dat_pds.af.pds.df, mean!=0)

dat_pds.af.pds.plot<-ggplot(data=dat_pds.af.pds, aes(x=pds, y=mean, group=soil_let, colour=Phylum)) + theme_bw() +
  facet_grid(Genus~soil_let, scales="free_y", labeller = labeller(soil_let = soil_let_labels, groupwrap = label_wrap_gen(10))) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering", "5"="Senescence", "6"="Final")) +
  stat_summary(fun=mean, geom="line", position=position_dodge(0.2)) +
  stat_summary(fun=mean, geom="point", position=position_dodge(0.2)) +
  geom_errorbar(aes(x=pds, ymin=mean-sd, ymax=mean+sd), position=position_dodge(0.2)) +
  #ggtitle("Dry Biomass") +
  xlab("Plant Developmental Phase") +
  ylab("Average Read Abundance") +
  theme(text = element_text(size=16), axis.text.x = element_text(angle=90, hjust=1, vjust=0.9)) +
  guides(colour=guide_legend(title="Phylum"))
dat_pds.af.pds.plot
#ggsave("/Users/anigwe/Desktop/supplementalfigure8.png", height=600, width=335, units='mm', dpi=400)
```
#Plant Growth Metrics
##Input data
```{r}
metadata.root <- read.csv("~/Desktop/R/serpnon_timeseries/input/pds_combined_root_forR.csv")
```
```{r}
metadata.root$height <- as.numeric(as.character(metadata.root$height))
metadata.root$leaf.num <- as.numeric(as.character(metadata.root$leaf.num))
metadata.root$date<- as.Date(metadata.root$date, "%m/%d/%Y")
year(metadata.root$date)<-2018
metadata.root$sample_num <- as.factor(metadata.root$sample_num)
metadata.root$tray <- as.factor(metadata.root$tray)
metadata.root$winrhizo_date<-as.Date(metadata.root$winrhizo_date, "%m/%d/%Y")
metadata.root$height<-as.numeric(metadata.root$height)
metadata.root$root_length<-as.numeric(as.character(metadata.root$root_length))
metadata.root$proj_area<-as.numeric(metadata.root$proj_area)
metadata.root$root_surfacearea<-as.numeric(as.character(metadata.root$root_surfacearea))
metadata.root$root_diameter<-as.numeric(as.character(metadata.root$root_diameter))
metadata.root$root_length_per_volume<-as.numeric(metadata.root$root_length_per_volume)
metadata.root$root_volume<-as.numeric(as.character(metadata.root$root_volume))
metadata.root$wet.biomass.above<-as.numeric(metadata.root$wet.biomass.above)
metadata.root$dry.biomass.above<-as.numeric(as.character(metadata.root$dry.biomass.above))
metadata.root$moisture.above<-as.numeric(metadata.root$moisture.above)
metadata.root<-subset(metadata.root,pds!="."&pds!="5"&pds!="6")
metadata.root<-subset(metadata.root, pds!="0")
metadata.root<-subset(metadata.root, soil_let!="CON")
```
##Figure 3
###height summary
```{r}
height_timeseries <- metadata.root %>% dplyr::group_by(soil_stress,pds,microbe_type) %>% dplyr::summarise(
  n=sum(!is.na(height)),
  sd(height , na.rm = TRUE),
  mean(height , na.rm = TRUE),
  min(height , na.rm = TRUE),
  max(height , na.rm = TRUE),
  var(height , na.rm = TRUE),
  se = sd(height, na.rm=T)/sqrt(sum(!is.na(height))))
colnames(height_timeseries)<-c("soil_stress","pds","microbe_type","n","sd","mean","min","max","var","se")
height_timeseries.df <- as.data.frame(height_timeseries)
print(height_timeseries)
sum(!is.na(metadata.root$height))
```
###height statistics
```{r}
lbs.lm.height <- lm(height~soil_stress*microbe_type*pds, data=metadata.root, na.action = na.exclude)
lbs.lm.height
summary(lbs.lm.height)
print(lbs.lm.height, correlation=TRUE)
vcov(lbs.lm.height)

aov.lbs.lm.height <- aov(lbs.lm.height)
aov.lbs.lm.height
summary(aov.lbs.lm.height)
TukeyHSD(aov.lbs.lm.height)
```
###leaf number summary
```{r}
leaf.num_timeseries <- metadata.root %>% dplyr::group_by(soil_stress,pds,microbe_type) %>% dplyr::summarise(
  n=sum(!is.na(leaf.num)),
  sd(leaf.num , na.rm = TRUE),
  mean(leaf.num , na.rm = TRUE),
  min(leaf.num , na.rm = TRUE),
  max(leaf.num , na.rm = TRUE),
  var(leaf.num , na.rm = TRUE),
  se = sd(leaf.num, na.rm=T)/sqrt(sum(!is.na(leaf.num))))
colnames(leaf.num_timeseries)<-c("soil_stress","pds","microbe_type","n","sd","mean","min","max","var","se")
leaf.num_timeseries.df <- as.data.frame(leaf.num_timeseries)
print(leaf.num_timeseries)
sum(!is.na(metadata.root$leaf.num))
```
###leaf number statistics
```{r}
lbs.lm.leaf.num <- lm(leaf.num~soil_stress*microbe_type*pds, data=metadata.root, na.action = na.exclude)
lbs.lm.leaf.num
summary(lbs.lm.leaf.num)
print(lbs.lm.leaf.num, correlation=TRUE)
vcov(lbs.lm.leaf.num)

aov.lbs.lm.leaf.num <- aov(lbs.lm.leaf.num)
aov.lbs.lm.leaf.num
summary(aov.lbs.lm.leaf.num)
TukeyHSD(aov.lbs.lm.leaf.num)
```
###dry biomass summary
```{r}
dry.biomass.above_timeseries <- metadata.root %>% dplyr::group_by(soil_stress,pds,microbe_type) %>% dplyr::summarise(
  n=sum(!is.na(dry.biomass.above)),
  sd(dry.biomass.above , na.rm = TRUE),
  mean(dry.biomass.above , na.rm = TRUE),
  min(dry.biomass.above , na.rm = TRUE),
  max(dry.biomass.above , na.rm = TRUE),
  var(dry.biomass.above , na.rm = TRUE),
  se = sd(dry.biomass.above, na.rm=T)/sqrt(sum(!is.na(dry.biomass.above))))
colnames(dry.biomass.above_timeseries)<-c("soil_stress","pds","microbe_type","n","sd","mean","min","max","var","se")
dry.biomass.above_timeseries.df <- as.data.frame(dry.biomass.above_timeseries)
print(dry.biomass.above_timeseries)
sum(!is.na(dry.biomass.above_timeseries$n))
sum((dry.biomass.above_timeseries$n))
```
###dry biomass statistics
```{r}
lbs.lm.dry.biomass.above <- lm(dry.biomass.above~soil_stress*microbe_type*pds, data=metadata.root, na.action = na.exclude)
lbs.lm.dry.biomass.above
summary(lbs.lm.dry.biomass.above)
print(lbs.lm.dry.biomass.above, correlation=TRUE)
vcov(lbs.lm.dry.biomass.above)

aov.lbs.lm.dry.biomass.above <- aov(lbs.lm.dry.biomass.above)
aov.lbs.lm.dry.biomass.above
summary(aov.lbs.lm.dry.biomass.above)
TukeyHSD(aov.lbs.lm.dry.biomass.above)
```
###Figure 3 - Height + Leaf + Biomass
```{r}
#height - a
height.plot<-ggplot(data=height_timeseries, aes(x=pds, y=mean, group=soil_stress, colour=soil_stress)) + theme_bw() +
  facet_grid(~microbe_type, labeller = labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering", "5"="Senescence", "6"="Final")) +
    stat_summary(fun=mean, geom="line", position=position_dodge(0.2)) +
    stat_summary(fun=mean, geom="point", position=position_dodge(0.2)) +
    geom_errorbar(aes(x=pds, ymin=mean-sd, ymax=mean+sd), position=position_dodge(0.2)) +
  ggtitle("Height") +
  xlab("Plant Developmental Phase") +
  ylab("Height(cm)") +
  theme(text = element_text(size=16), axis.text.x = element_text(angle=90, hjust=1, vjust=0.9)) +
  guides(colour=guide_legend(title="Soil Type"))
height.plot
```
```{r}
#leaf number - b
ln.box <- ggplot(leaf.num_timeseries, aes(x=pds, y=mean, group=soil_stress, colour=soil_stress)) + theme_bw() +
  facet_grid(~microbe_type, labeller = labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering", "5"="Senescence", "6"="Final")) +
    stat_summary(fun=mean, geom="line", position=position_dodge(0.2)) +
    stat_summary(fun=mean, geom="point", position=position_dodge(0.2)) +
    geom_errorbar(aes(x=pds, ymin=mean-sd, ymax=mean+sd), position=position_dodge(0.2)) +
  ggtitle("Leaf Number") +
  xlab("Plant Developmental Phase") +
  ylab("Number") +
  theme(text = element_text(size=16), axis.text.x = element_text(angle=90, hjust=1, vjust=0.9)) +
  guides(colour=guide_legend(title="Soil Type"))
ln.box
```
```{r}
dry.biomass.above.plot<-ggplot(data=dry.biomass.above_timeseries, aes(x=pds, y=mean, group=soil_stress, colour=soil_stress)) + theme_bw() +
  facet_grid(~microbe_type, labeller = labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering", "5"="Senescence", "6"="Final")) +
    stat_summary(fun=mean, geom="line", position=position_dodge(0.2)) +
    stat_summary(fun=mean, geom="point", position=position_dodge(0.2)) +
  geom_errorbar(aes(x=pds, ymin=mean-sd, ymax=mean+sd), position=position_dodge(0.2)) +
  ggtitle("Dry Biomass") +
  xlab("Plant Developmental Phase") +
  ylab("Weight (g)") +
  theme(text = element_text(size=16), axis.text.x = element_text(angle=90, hjust=1, vjust=0.9)) +
  guides(colour=guide_legend(title="Soil Type"))
dry.biomass.above.plot
```
```{r}
fig.3<-ggarrange(height.plot,ln.box,dry.biomass.above.plot,labels="auto",ncol=3,common.legend=TRUE,legend="bottom")
fig.3
```
##Figure 4
###root length summary
```{r}
length_timeseries <- metadata.root %>% dplyr::group_by(soil_stress,pds,microbe_type) %>% dplyr::summarise(
  n=sum(!is.na(root_length)),
  sd(root_length , na.rm = TRUE),
  mean(root_length , na.rm = TRUE),
  min(root_length , na.rm = TRUE),
  max(root_length , na.rm = TRUE),
  var(root_length , na.rm = TRUE),
  se = sd(root_length, na.rm=T)/sqrt(sum(!is.na(root_length))))
colnames(length_timeseries)<-c("soil_stress","pds","microbe_type","n","sd","mean","min","max","var","se")
length_timeseries.df <- as.data.frame(length_timeseries)
print(length_timeseries)
sum(!is.na(metadata.root$root_length))
sum((length_timeseries$n))
```
###root length statistics
```{r}
lbs.lm.root_length <- lm(root_length~soil_stress*microbe_type*pds, data=metadata.root, na.action = na.exclude)
lbs.lm.root_length
summary(lbs.lm.root_length)
print(lbs.lm.root_length, correlation=TRUE)
vcov(lbs.lm.root_length)

aov.lbs.lm.root_length <- aov(lbs.lm.root_length)
aov.lbs.lm.root_length
summary(aov.lbs.lm.root_length)
TukeyHSD(aov.lbs.lm.root_length)
```
###root diameter summary
```{r}
diameter_timeseries <- metadata.root %>% dplyr::group_by(soil_stress,pds,microbe_type) %>% dplyr::summarise(
  n=sum(!is.na(root_diameter)),
  sd(root_diameter , na.rm = TRUE),
  mean(root_diameter , na.rm = TRUE),
  min(root_diameter , na.rm = TRUE),
  max(root_diameter , na.rm = TRUE),
  var(root_diameter , na.rm = TRUE),
  se = sd(root_diameter, na.rm=T)/sqrt(sum(!is.na(root_diameter))))
colnames(diameter_timeseries)<-c("soil_stress","pds","microbe_type","n","sd","mean","min","max","var","se")
diameter_timeseries.df <- as.data.frame(diameter_timeseries)
print(diameter_timeseries)
sum((diameter_timeseries$n))
```
###root diameter statistics
```{r}
lbs.lm.root_diameter <- lm(root_diameter~soil_stress*microbe_type*pds, data=metadata.root, na.action = na.exclude)
lbs.lm.root_diameter
summary(lbs.lm.root_diameter)
print(lbs.lm.root_diameter, correlation=TRUE)

aov.lbs.lm.root_diameter <- aov(lbs.lm.root_diameter)
aov.lbs.lm.root_diameter
summary(aov.lbs.lm.root_diameter)
TukeyHSD(aov.lbs.lm.root_diameter)
```
###surface area summary
```{r}
metadata.root.4<-subset(metadata.root, pds==4)
surfacearea_timeseries <- metadata.root %>% dplyr::group_by(soil_stress,pds,microbe_type) %>% dplyr::summarise(
  n=sum(!is.na(root_surfacearea)),
  sd(root_surfacearea , na.rm = TRUE),
  mean(root_surfacearea , na.rm = TRUE),
  min(root_surfacearea , na.rm = TRUE),
  max(root_surfacearea , na.rm = TRUE),
  var(root_surfacearea , na.rm = TRUE),
  se = sd(root_surfacearea, na.rm=T)/sqrt(sum(!is.na(root_surfacearea))))
colnames(surfacearea_timeseries)<-c("soil_stress","pds","microbe_type","n","sd","mean","min","max","var","se")
surfacearea_timeseries.df <- as.data.frame(surfacearea_timeseries)
print(surfacearea_timeseries)
sum((surfacearea_timeseries$n))
```
###surface area statistics
```{r}
lbs.lm.surfacearea <- lm(root_surfacearea~soil_stress*microbe_type*pds, data=metadata.root, na.action = na.exclude)
lbs.lm.surfacearea
summary(lbs.lm.surfacearea)
print(lbs.lm.surfacearea, correlation=TRUE)

aov.lbs.lm.surfacearea <- aov(lbs.lm.surfacearea)
aov.lbs.lm.surfacearea
summary(aov.lbs.lm.surfacearea)
TukeyHSD(aov.lbs.lm.surfacearea)
```
###root volume summary
```{r}
volume_timeseries <- metadata.root %>% dplyr::group_by(soil_stress,pds,microbe_type) %>% dplyr::summarise(
  n=sum(!is.na(root_volume)),
  sd(root_volume , na.rm = TRUE),
  mean(root_volume , na.rm = TRUE),
  min(root_volume , na.rm = TRUE),
  max(root_volume , na.rm = TRUE),
  var(root_volume , na.rm = TRUE),
  se = sd(root_volume, na.rm=T)/sqrt(sum(!is.na(root_volume))))
colnames(volume_timeseries)<-c("soil_stress","pds","microbe_type","n","sd","mean","min","max","var","se")
volume_timeseries.df <- as.data.frame(volume_timeseries)
print(volume_timeseries)
sum(!is.na(volume_timeseries$n))
```
###root volume statistics
```{r}
lbs.lm.volume <- lm(root_volume~soil_stress*microbe_type*pds, data=metadata.root, na.action = na.exclude)
lbs.lm.volume
summary(lbs.lm.volume)
print(lbs.lm.volume, correlation=TRUE)

aov.lbs.lm.volume <- aov(lbs.lm.volume)
aov.lbs.lm.volume
summary(aov.lbs.lm.volume)
TukeyHSD(aov.lbs.lm.volume)
```

###Figure 4 - Length + Diameter + Surface Area + Volume
```{r}
root.box.length<-ggplot(data=length_timeseries, aes(x=pds, y=mean, group=soil_stress, colour=soil_stress)) + theme_bw() +
  facet_grid(~microbe_type, labeller = labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering", "5"="Senescence", "6"="Final")) +
    stat_summary(fun=mean, geom="line", position=position_dodge(0.2)) +
    stat_summary(fun=mean, geom="point", position=position_dodge(0.2)) +
    geom_errorbar(aes(x=pds, ymin=mean-sd, ymax=mean+sd), position=position_dodge(0.2)) +
  ggtitle("Root Length") +
  xlab("Plant Developmental Phase") +
  ylab("Length (cm)") +
  theme(axis.title.x = element_blank()) +
  theme(text=element_text(size=16), axis.text.x =element_blank()) +
  #theme(text = element_text(size=16), axis.text.x = element_text(angle=90, hjust=1, vjust=0.9)) +
  guides(colour=guide_legend(title="Soil Type"))
root.box.length
```
```{r}
root.box.diameter<-ggplot(data=diameter_timeseries, aes(x=pds, y=mean, group=soil_stress, colour=soil_stress)) + theme_bw() +
  facet_grid(~microbe_type, labeller = labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering", "5"="Senescence", "6"="Final")) +
    stat_summary(fun=mean, geom="line", position=position_dodge(0.2)) +
    stat_summary(fun=mean, geom="point", position=position_dodge(0.2)) +
    geom_errorbar(aes(x=pds, ymin=mean-sd, ymax=mean+sd), position=position_dodge(0.2)) +
  ggtitle("Root Diameter") +
  xlab("Plant Developmental Phase") +
  ylab("Diameter (cm)") +
  theme(axis.title.x = element_blank()) +
  theme(text=element_text(size=16), axis.text.x =element_blank()) +
  #theme(text = element_text(size=16), axis.text.x = element_text(angle=90, hjust=1, vjust=0.9)) +
  guides(colour=guide_legend(title="Soil Type"))
root.box.diameter
```
```{r}
root.box.surfacearea<-ggplot(data=surfacearea_timeseries, aes(x=pds, y=mean, group=soil_stress, colour=soil_stress)) + theme_bw() +
  facet_grid(~microbe_type, labeller = labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering", "5"="Senescence", "6"="Final")) +
    stat_summary(fun=mean, geom="line", position=position_dodge(0.2)) +
    stat_summary(fun=mean, geom="point", position=position_dodge(0.2)) +
    geom_errorbar(aes(x=pds, ymin=mean-sd, ymax=mean+sd), position=position_dodge(0.2)) +
  ggtitle("Root Surface Area") +
  xlab("Plant Developmental Phase") +
  ylab("Surface Area (cm2)") +
  theme(text = element_text(size=16), axis.text.x = element_text(angle=45, hjust=1, vjust=1)) +
  guides(colour=guide_legend(title="Soil Type"))
root.box.surfacearea
```
```{r}
root.box.volume<-ggplot(data=volume_timeseries, aes(x=pds, y=mean, group=soil_stress, colour=soil_stress)) + theme_bw() +
  facet_grid(~microbe_type, labeller = labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering", "5"="Senescence", "6"="Final")) +
    stat_summary(fun=mean, geom="line", position=position_dodge(0.2)) +
    stat_summary(fun=mean, geom="point", position=position_dodge(0.2)) +
    geom_errorbar(aes(x=pds, ymin=mean-sd, ymax=mean+sd), position=position_dodge(0.2)) +
  ggtitle("Root Volume") +
  xlab("Plant Developmental Phase") +
  ylab("Volume (cm3)") +
  theme(text = element_text(size=16), axis.text.x = element_text(angle=45, hjust=1, vjust=1)) +
  guides(colour=guide_legend(title="Soil Type"))
root.box.volume
```
```{r}
library(patchwork)
#fig.4<-ggarrange(root.box.length,root.box.diameter,root.box.surfacearea,root.box.volume,common.legend=TRUE,labels="auto",legend="bottom",ncol=2,nrow=2, heights = c(1,1))

fig.4 <- (root.box.length + root.box.diameter)/(root.box.surfacearea + root.box.volume) + plot_layout(guides = "collect") & theme(legend.position = "bottom")
fig.4
```
#Survival Analysis - Table 1
```{r references}
#http://www.sthda.com/english/wiki/identifying-and-removing-duplicate-data-in-r
#https://www.datacamp.com/community/tutorials/survival-analysis-R
#https://github.com/kassambara/survminer/issues/67
#http://sphweb.bumc.bu.edu/otlt/MPH-Modules/BS/R/R7_LogisticRegression-Survival/R7_LogisticRegression-Survival4.html
#https://rpubs.com/daspringate/survival
#http://rpubs.com/sinhrks/plot_surv
#https://stats.idre.ucla.edu/r/faq/how-can-i-identify-the-first-and-last-observations-within-a-group-in-r/
#https://bioconnector.org/r-survival.html
#https://stackoverflow.com/questions/19944334/extract-rows-for-the-first-occurrence-of-a-variable-in-a-data-frame
#http://www.sthda.com/english/rpkgs/survminer/survminer_cheatsheet.pdf
#import data, change "Date" format
```
##Input data
```{r}
#time series analysis with pds_combined
#import combined timeseries data and change object structures. each row is a sample and columns include information concerning plant developmental stage and date.
timeseries <- read.csv("~/Desktop/R/serpnon_timeseries/input/timeseries_combined_survival.csv", na.strings=c(".", " ", "", "NA"))
str(timeseries)
timeseries<-subset(timeseries, soil_let!="CON" & pds!="0")
timeseries$sample_num <- as.factor(timeseries$sample_num)
timeseries$dna_id <- as.factor(timeseries$dna_id)
timeseries$date.dna = as.Date(timeseries$date.dna, "%m/%d/%Y")
timeseries$date.8.22.2018 = as.Date(timeseries$date.8.22.2018, "%m/%d/%Y")
timeseries$date.8.29.2018 = as.Date(timeseries$date.8.29.2018, "%m/%d/%Y")
timeseries$date.9.3.2018 = as.Date(timeseries$date.9.3.2018, "%m/%d/%Y")
timeseries$date.9.10.2018 = as.Date(timeseries$date.9.10.2018, "%m/%d/%Y")
timeseries$date.9.17.2018 = as.Date(timeseries$date.9.17.2018, "%m/%d/%Y")
timeseries$date.9.24.2018 = as.Date(timeseries$date.9.24.2018, "%m/%d/%Y")
timeseries$date.10.1.2018 = as.Date(timeseries$date.10.1.2018, "%m/%d/%Y")
timeseries$date.10.8.2018 = as.Date(timeseries$date.10.8.2018, "%m/%d/%Y")
timeseries$date.10.15.2018 = as.Date(timeseries$date.10.15.2018, "%m/%d/%Y")
timeseries$date.10.22.2018 = as.Date(timeseries$date.10.22.2018, "%m/%d/%Y")
timeseries$date.11.12.2018 = as.Date(timeseries$date.11.12.2018, "%m/%d/%Y")
timeseries$date.11.19.2018 = as.Date(timeseries$date.11.19.2018, "%m/%d/%Y")
timeseries$date.11.26.2018 = as.Date(timeseries$date.11.26.2018, "%m/%d/%Y")
```
##Survival analysis - Bolting
```{r}
#subset instances of seedlings for each column date (pds.[date]=="1")
timeseries2<-subset(timeseries,pds!="1"&pds!="6")
serp_pds1 <- subset(timeseries2, pds.8.22.2018=="1")
#if number of observations is different, check to see which samples are missing
rownames(serp_pds1) <- serp_pds1$sample_num
rownames(timeseries2) <- timeseries2$sample_num
q.bolt <- !rownames(timeseries2) %in% serp_pds1$sample_num
q.bolt
qf.list.bolt<-as.data.frame(timeseries2 [q.bolt, ])

#subset instances of flowering for each column date (pds.[date]=="2")
serp_pds.8.29.2018_2 <- subset(timeseries2, pds.8.29.2018=="2")
serp_pds.9.3.2018_2 <- subset(timeseries2, pds.9.3.2018=="2")
serp_pds.9.10.2018_2 <- subset(timeseries2, pds.9.10.2018=="2")
serp_pds.9.17.2018_2 <- subset(timeseries2, pds.9.17.2018=="2")
serp_pds.9.24.2018_2 <- subset(timeseries2, pds.9.24.2018=="2")
serp_pds.10.1.2018_2 <- subset(timeseries2, pds.10.1.2018=="2")
serp_pds.10.8.2018_2 <- subset(timeseries2, pds.10.8.2018=="2")
serp_pds.10.15.2018_2 <- subset(timeseries2, pds.10.15.2018=="2")
serp_pds.10.22.2018_2 <- subset(timeseries2, pds.10.22.2018=="2")
serp_pds.11.12.2018_2 <- subset(timeseries2, pds.11.12.2018=="2")
serp_pds.11.19.2018_2 <- subset(timeseries2, pds.11.19.2018=="2")
serp_pds.11.26.2018_2 <- subset(timeseries2, pds.11.26.2018=="2")
#combine pds1 and pds4 data frames for each date that has observations
serp_8.29.2018_pds12 <- rbind(serp_pds1, serp_pds.8.29.2018_2)
serp_9.3.2018_pds12 <- rbind(serp_pds1, serp_pds.9.3.2018_2)
serp_9.10.2018_pds12 <- rbind(serp_pds1, serp_pds.9.10.2018_2)
serp_9.17.2018_pds12 <- rbind(serp_pds1, serp_pds.9.17.2018_2)
serp_9.24.2018_pds12 <- rbind(serp_pds1, serp_pds.9.24.2018_2)
serp_10.1.2018_pds12 <- rbind(serp_pds1, serp_pds.10.1.2018_2)
serp_10.8.2018_pds12 <- rbind(serp_pds1, serp_pds.10.8.2018_2)
serp_10.15.2018_pds12 <- rbind(serp_pds1, serp_pds.10.15.2018_2)
serp_10.22.2018_pds12 <- rbind(serp_pds1, serp_pds.10.22.2018_2)
serp_11.12.2018_pds12 <- rbind(serp_pds1, serp_pds.11.12.2018_2)
serp_11.19.2018_pds12 <- rbind(serp_pds1, serp_pds.11.19.2018_2)
#calculate time to event ("pds" == 4)
#date.8.22.2018 - lag(date.10.1.2018)
bolt.2 <- serp_8.29.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.8.29.2018 - lag(date.8.22.2018))
bolt.2
#subset to include observations that have a time difference
bolt.2.t <- subset(bolt.2, diff!="NA")
bolt.2.t$stop <- bolt.2.t$diff
#calculate time to event ("pds" == 4)
bolt.3 <- serp_9.3.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.9.3.2018 - lag(date.8.22.2018))
bolt.3
#subset to include observations that have a time difference
bolt.3.t <- subset(bolt.3, diff!="NA")
bolt.3.t$stop <- bolt.3.t$diff
#calculate time to event ("pds" == 4)
bolt.4 <- serp_9.10.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.9.10.2018 - lag(date.8.22.2018))
bolt.4
#subset to include observations that have a time difference
bolt.4.t <- subset(bolt.4, diff!="NA")
bolt.4.t$stop <- bolt.4.t$diff
#calculate time to event ("pds" == 4)
bolt.5 <- serp_9.17.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.9.17.2018 - lag(date.8.22.2018))
bolt.5
#subset to include observations that have a time difference
bolt.5.t <- subset(bolt.5, diff!="NA")
bolt.5.t$stop <- bolt.5.t$diff
#calculate time to event ("pds" == 4)
bolt.6 <- serp_9.24.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.9.24.2018 - lag(date.8.22.2018))
bolt.6
#subset to include observations that have a time difference
bolt.6.t <- subset(bolt.6, diff!="NA")
bolt.6.t$stop <- bolt.6.t$diff
#calculate time to event ("pds" == 4)
bolt.7 <- serp_10.1.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.1.2018 - lag(date.8.22.2018))
bolt.7
#subset to include observations that have a time difference
bolt.7.t <- subset(bolt.7, diff!="NA")
bolt.7.t$stop <- bolt.7.t$diff
#calculate time to event ("pds" == 4)
bolt.8 <- serp_10.8.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.8.2018 - lag(date.8.22.2018))
bolt.8
#subset to include observations that have a time difference
bolt.8.t <- subset(bolt.8, diff!="NA")
bolt.8.t$stop <- bolt.8.t$diff
#calculate time to event ("pds" == 4)
bolt.9 <- serp_10.15.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.15.2018 - lag(date.8.22.2018))
bolt.9
#subset to include observations that have a time difference
bolt.9.t <- subset(bolt.9, diff!="NA")
bolt.9.t$stop <- bolt.9.t$diff
#calculate time to event ("pds" == 4)
bolt.10 <- serp_10.22.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.22.2018 - lag(date.8.22.2018))
bolt.10
#subset to include observations that have a time difference
bolt.10.t <- subset(bolt.10, diff!="NA")
bolt.10.t$stop <- bolt.10.t$diff
#calculate time to event ("pds" == 4)
bolt.11 <- serp_11.12.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.11.12.2018 - lag(date.8.22.2018))
bolt.11
#subset to include observations that have a time difference
bolt.11.t <- subset(bolt.11, diff!="NA")
bolt.11.t$stop <- bolt.11.t$diff
#calculate time to event ("pds" == 4)
bolt.12 <- serp_11.12.2018_pds12 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.11.12.2018 - lag(date.8.22.2018))
bolt.12
#subset to include observations that have a time difference
bolt.12.t <- subset(bolt.11, diff!="NA")
bolt.12.t$stop <- bolt.12.t$diff



#combine data frames with lag time
serp_pds12<-rbind(bolt.2.t,bolt.3.t,bolt.4.t,bolt.5.t,bolt.6.t,bolt.7.t,bolt.8.t,bolt.9.t,bolt.10.t,bolt.11.t,bolt.12.t)
#check for dublicate samples
table(serp_pds12$sample_num)
#select for unique samples
#serp_pds14 <- serp_pds14[match(unique(serp_pds14$sample_num), serp_pds14$sample_num),]
serp_pds12 <- serp_pds12[!duplicated(serp_pds12$sample_num), ]
#drop treatments with 0 observations
#serp_pds14$soil_let <- droplevels(serp_pds14)$soil_let
#add event binary event column
serp_pds12$bolting <- 1

#create data.frame with samples not in combined data frame (serp_pds14)
rownames(serp_pds12) <- serp_pds12$sample_num
rownames(timeseries2) <- timeseries2$sample_num
r.bolt <- !rownames(timeseries2) %in% serp_pds12$sample_num
r.bolt
rf.list.bolt<-as.data.frame(timeseries2 [r.bolt, ])
#rf.list.bolt$diff <- 0
#rf.list.bolt$stop <- 0
#rf.list.bolt$bolting <- 0
class(serp_pds12)
class(rf.list.bolt)
serp_pds12_all<-rbind(as.data.frame(serp_pds12),rf.list.bolt)
serp_pds12_all$bolting <- as.integer(serp_pds12_all$bolting)
str(serp_pds12_all$bolting)
str(serp_pds12_all$date.8.22.2018)

#survival analysis
S.bolt <- Surv(
  #time = serp_pds14_all$start, 
  time = serp_pds12_all$stop, 
  event = serp_pds12_all$bolting)

model.bolt<-survfit(S.bolt~soil_let, data=serp_pds12_all)
model.bolt
plot.fit.soil_let_12 <- ggsurvplot((model.bolt),data=serp_pds12_all, fun="event", conf.int = FALSE, censor=FALSE, legend.title = "Treatment", xlab = "Days to Bolting", ylab = "Overall Bolting Probability")
plot.fit.soil_let_12<-plot.fit.soil_let_12$plot + theme_bw()+facet_wrap(.~soil_let)
plot.fit.soil_let_12

serp_pds12_all$soil_stress = relevel(serp_pds12_all$soil_stress, ref = "S")
serp_pds12_all$microbe_type = relevel(serp_pds12_all$microbe_type, ref = "serpentine")

serp_pds12_all$soil_let <- droplevels(serp_pds12_all)$soil_let

model.cox_soil_let_12<- coxph(S~soil_let, data=serp_pds12_all)
ggforest(model.cox_soil_let_12, data=serp_pds12_all)
```
##Survival analysis - Vegetative
```{r}
#subset instances of seedlings for each column date (pds.[date]=="1")
timeseries2<-subset(timeseries,pds!="1"&pds!="6")
serp_pds1 <- subset(timeseries2, pds.8.22.2018=="1")
#if number of observations is different, check to see which samples are missing
rownames(serp_pds1) <- serp_pds1$sample_num
rownames(timeseries2) <- timeseries2$sample_num
q.veg <- !rownames(timeseries2) %in% serp_pds1$sample_num
q.veg
qf.list.veg<-as.data.frame(timeseries2 [q.veg, ])

#subset instances of flowering for each column date (pds.[date]=="2")
serp_pds.8.29.2018_3 <- subset(timeseries2, pds.8.29.2018=="3")
serp_pds.9.3.2018_3 <- subset(timeseries2, pds.9.3.2018=="3")
serp_pds.9.10.2018_3 <- subset(timeseries2, pds.9.10.2018=="3")
serp_pds.9.17.2018_3 <- subset(timeseries2, pds.9.17.2018=="3")
serp_pds.9.24.2018_3 <- subset(timeseries2, pds.9.24.2018=="3")
serp_pds.10.1.2018_3 <- subset(timeseries2, pds.10.1.2018=="3")
serp_pds.10.8.2018_3 <- subset(timeseries2, pds.10.8.2018=="3")
serp_pds.10.15.2018_3 <- subset(timeseries2, pds.10.15.2018=="3")
serp_pds.10.22.2018_3 <- subset(timeseries2, pds.10.22.2018=="3")
serp_pds.11.12.2018_3 <- subset(timeseries2, pds.11.12.2018=="3")
serp_pds.11.19.2018_3 <- subset(timeseries2, pds.11.19.2018=="3")
serp_pds.11.26.2018_3 <- subset(timeseries2, pds.11.26.2018=="3")
#combine pds1 and pds4 data frames for each date that has observations
serp_8.29.2018_pds13 <- rbind(serp_pds1, serp_pds.8.29.2018_3)
serp_9.3.2018_pds13 <- rbind(serp_pds1, serp_pds.9.3.2018_3)
serp_9.10.2018_pds13 <- rbind(serp_pds1, serp_pds.9.10.2018_3)
serp_9.17.2018_pds13 <- rbind(serp_pds1, serp_pds.9.17.2018_3)
serp_9.24.2018_pds13 <- rbind(serp_pds1, serp_pds.9.24.2018_3)
serp_10.1.2018_pds13 <- rbind(serp_pds1, serp_pds.10.1.2018_3)
serp_10.8.2018_pds13 <- rbind(serp_pds1, serp_pds.10.8.2018_3)
serp_10.15.2018_pds13 <- rbind(serp_pds1, serp_pds.10.15.2018_3)
serp_10.22.2018_pds13 <- rbind(serp_pds1, serp_pds.10.22.2018_3)
serp_11.12.2018_pds13 <- rbind(serp_pds1, serp_pds.11.12.2018_3)
serp_11.19.2018_pds13 <- rbind(serp_pds1, serp_pds.11.19.2018_3)
#calculate time to event ("pds" == 4)
#date.8.22.2018 - lag(date.10.1.2018)
veg.2 <- serp_8.29.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.8.29.2018 - lag(date.8.22.2018))
veg.2
#subset to include observations that have a time difference
veg.2.t <- subset(veg.2, diff!="NA")
veg.2.t$stop <- veg.2.t$diff
#calculate time to event ("pds" == 4)
veg.3 <- serp_9.3.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.9.3.2018 - lag(date.8.22.2018))
veg.3
#subset to include observations that have a time difference
veg.3.t <- subset(veg.3, diff!="NA")
veg.3.t$stop <- veg.3.t$diff
#calculate time to event ("pds" == 4)
veg.4 <- serp_9.10.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.9.10.2018 - lag(date.8.22.2018))
veg.4
#subset to include observations that have a time difference
veg.4.t <- subset(veg.4, diff!="NA")
veg.4.t$stop <- veg.4.t$diff
#calculate time to event ("pds" == 4)
veg.5 <- serp_9.17.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.9.17.2018 - lag(date.8.22.2018))
veg.5
#subset to include observations that have a time difference
veg.5.t <- subset(veg.5, diff!="NA")
veg.5.t$stop <- veg.5.t$diff
#calculate time to event ("pds" == 4)
veg.6 <- serp_9.24.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.9.24.2018 - lag(date.8.22.2018))
veg.6
#subset to include observations that have a time difference
veg.6.t <- subset(veg.6, diff!="NA")
veg.6.t$stop <- veg.6.t$diff
#calculate time to event ("pds" == 4)
veg.7 <- serp_10.1.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.1.2018 - lag(date.8.22.2018))
veg.7
#subset to include observations that have a time difference
veg.7.t <- subset(veg.7, diff!="NA")
veg.7.t$stop <- veg.7.t$diff
#calculate time to event ("pds" == 4)
veg.8 <- serp_10.8.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.8.2018 - lag(date.8.22.2018))
veg.8
#subset to include observations that have a time difference
veg.8.t <- subset(veg.8, diff!="NA")
veg.8.t$stop <- veg.8.t$diff
#calculate time to event ("pds" == 4)
veg.9 <- serp_10.15.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.15.2018 - lag(date.8.22.2018))
veg.9
#subset to include observations that have a time difference
veg.9.t <- subset(veg.9, diff!="NA")
veg.9.t$stop <- veg.9.t$diff
#calculate time to event ("pds" == 4)
veg.10 <- serp_10.22.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.22.2018 - lag(date.8.22.2018))
veg.10
#subset to include observations that have a time difference
veg.10.t <- subset(veg.10, diff!="NA")
veg.10.t$stop <- veg.10.t$diff
#calculate time to event ("pds" == 4)
veg.11 <- serp_11.12.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.11.12.2018 - lag(date.8.22.2018))
veg.11
#subset to include observations that have a time difference
veg.11.t <- subset(veg.11, diff!="NA")
veg.11.t$stop <- veg.11.t$diff
#calculate time to event ("pds" == 4)
veg.12 <- serp_11.12.2018_pds13 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.11.12.2018 - lag(date.8.22.2018))
veg.12
#subset to include observations that have a time difference
veg.12.t <- subset(veg.11, diff!="NA")
veg.12.t$stop <- veg.12.t$diff

#combine data frames with lag time
serp_pds13<-rbind(veg.2.t,veg.3.t,veg.4.t,veg.5.t,veg.6.t,veg.7.t,veg.8.t,veg.9.t,veg.10.t,veg.11.t,veg.12.t)
#check for dublicate samples
table(serp_pds13$sample_num)
#select for unique samples
#serp_pds14 <- serp_pds14[match(unique(serp_pds14$sample_num), serp_pds14$sample_num),]
serp_pds13 <- serp_pds13[!duplicated(serp_pds13$sample_num), ]
#drop treatments with 0 observations
#serp_pds14$soil_let <- droplevels(serp_pds14)$soil_let
#add event binarveg. event column
serp_pds13$vegetative <- 1

#create data.frame with samples not in combined data frame (serp_pds14)
rownames(serp_pds13) <- serp_pds13$sample_num
rownames(timeseries2) <- timeseries2$sample_num
r.veg <- !rownames(timeseries2) %in% serp_pds13$sample_num
r.veg
rf.list.veg<-as.data.frame(timeseries2 [r.veg, ])
rf.list.veg$diff <- 0
rf.list.veg$stop <- 0
rf.list.veg$vegetative <- 0
class(serp_pds13)
class(rf.list.veg)
serp_pds13_all<-rbind(as.data.frame(serp_pds13),rf.list.veg)
serp_pds13_all$vegetative <- as.integer(serp_pds13_all$vegetative)
str(serp_pds13_all$vegetative)
str(serp_pds13_all$date.8.22.2018)

#survival analysis
S.veg <- Surv(
  #time = serp_pds14_all$start, 
  time = serp_pds13_all$stop, 
  event = serp_pds13_all$vegetative)

model.veg<-survfit(S.veg~soil_let, data=serp_pds13_all)
model.veg
plot.fit.soil_let_13 <- ggsurvplot((model.veg),data=serp_pds13_all, fun="event", conf.int = TRUE, censor=FALSE, legend.title = "Treatment", xlab = "Days to Vegetative Growth", ylab = "Overall Vegetative Growth Probability")
plot.fit.soil_let_13<-plot.fit.soil_let_13$plot + theme_bw()+facet_wrap(.~soil_let)
plot.fit.soil_let_13

serp_pds13_all$soil_let <- droplevels(serp_pds13_all)$soil_let

serp_pds13_all$soil_stress = relevel(serp_pds13_all$soil_stress, ref = "S")
serp_pds13_all$microbe_type = relevel(serp_pds13_all$microbe_type, ref = "serpentine")

model.cox_soil_let_13<- coxph(S.veg~soil_let, data=serp_pds13_all)
ggforest(model.cox_soil_let_13, data=serp_pds13_all)
```
##Survival analysis - Flowering
```{r}
#subset instances of seedlings for each column date (pds.[date]=="1")
timeseries2<-subset(timeseries,pds!="1"&pds!="6")
serp_pds1 <- subset(timeseries2, pds.8.22.2018=="1")
#if number of observations is different, check to see which samples are missing
rownames(serp_pds1) <- serp_pds1$sample_num
rownames(timeseries2) <- timeseries2$sample_num
q.flow <- !rownames(timeseries2) %in% serp_pds1$sample_num
q.flow
qf.list.flow<-as.data.frame(timeseries2 [q.flow, ])

#subset instances of flowering for each column date (pds.[date]=="4")
serp_pds.8.29.2018_4 <- subset(timeseries2, pds.8.29.2018=="4")
serp_pds.9.3.2018_4 <- subset(timeseries2, pds.9.3.2018=="4")
serp_pds.9.10.2018_4 <- subset(timeseries2, pds.9.10.2018=="4")
serp_pds.9.17.2018_4 <- subset(timeseries2, pds.9.17.2018=="4")
serp_pds.9.24.2018_4 <- subset(timeseries2, pds.9.24.2018=="4")
serp_pds.10.1.2018_4 <- subset(timeseries2, pds.10.1.2018=="4")
serp_pds.10.8.2018_4 <- subset(timeseries2, pds.10.8.2018=="4")
serp_pds.10.15.2018_4 <- subset(timeseries2, pds.10.15.2018=="4")
serp_pds.10.22.2018_4 <- subset(timeseries2, pds.10.22.2018=="4")
serp_pds.11.12.2018_4 <- subset(timeseries2, pds.11.12.2018=="4")
serp_pds.11.19.2018_4 <- subset(timeseries2, pds.11.19.2018=="4")
serp_pds.11.26.2018_4 <- subset(timeseries2, pds.11.26.2018=="4")
#combine pds1 and pds4 data frames for each date that has observations
serp_10.1.2018_pds14 <- rbind(serp_pds1, serp_pds.10.1.2018_4)
serp_10.8.2018_pds14 <- rbind(serp_pds1, serp_pds.10.8.2018_4)
serp_10.15.2018_pds14 <- rbind(serp_pds1, serp_pds.10.15.2018_4)
serp_10.22.2018_pds14 <- rbind(serp_pds1, serp_pds.10.22.2018_4)
serp_11.12.2018_pds14 <- rbind(serp_pds1, serp_pds.11.12.2018_4)
serp_11.19.2018_pds14 <- rbind(serp_pds1, serp_pds.11.19.2018_4)
#calculate time to event ("pds" == 4)
#date.8.22.2018 - lag(date.10.1.2018)
flow.2 <- serp_10.1.2018_pds14 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.1.2018 - lag(date.8.22.2018))
flow.2
#subset to include observations that have a time difference
flow.2.t <- subset(flow.2, diff!="NA")
flow.2.t$stop <- flow.2.t$diff
#calculate time to event ("pds" == 4)
flow.3 <- serp_10.8.2018_pds14 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.8.2018 - lag(date.8.22.2018))
flow.3
#subset to include observations that have a time difference
flow.3.t <- subset(flow.3, diff!="NA")
flow.3.t$stop <- flow.3.t$diff
#calculate time to event ("pds" == 4)
flow.4 <- serp_10.15.2018_pds14 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.15.2018 - lag(date.8.22.2018))
flow.4
#subset to include observations that have a time difference
flow.4.t <- subset(flow.4, diff!="NA")
flow.4.t$stop <- flow.4.t$diff
#calculate time to event ("pds" == 4)
flow.5 <- serp_10.22.2018_pds14 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.10.22.2018 - lag(date.8.22.2018))
flow.5
#subset to include observations that have a time difference
flow.5.t <- subset(flow.5, diff!="NA")
flow.5.t$stop <- flow.5.t$diff
#calculate time to event ("pds" == 4)
flow.6 <- serp_11.12.2018_pds14 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.11.12.2018 - lag(date.8.22.2018))
flow.6
#subset to include observations that have a time difference
flow.6.t <- subset(flow.6, diff!="NA")
flow.6.t$stop <- flow.6.t$diff
#calculate time to event ("pds" == 4)
flow.7 <- serp_11.19.2018_pds14 %>%
  arrange(sample_num) %>%
  group_by(sample_num) %>%
  mutate(diff = date.11.19.2018 - lag(date.8.22.2018))
flow.7
#subset to include observations that have a time difference
flow.7.t <- subset(flow.7, diff!="NA")
flow.7.t$stop <- flow.7.t$diff

#combine data frames with lag time
serp_pds14<-rbind(flow.2.t,flow.3.t,flow.4.t,flow.5.t,flow.6.t,flow.7.t)
#check for dublicate samples
table(serp_pds14$sample_num)
#select for unique samples
#serp_pds14 <- serp_pds14[match(unique(serp_pds14$sample_num), serp_pds14$sample_num),]
serp_pds14 <- serp_pds14[!duplicated(serp_pds14$sample_num), ]
#drop treatments with 0 observations
#serp_pds14$soil_let <- droplevels(serp_pds14)$soil_let
#add event binarflow. event column
serp_pds14$flowering <- 1

#create data.frame with samples not in combined data frame (serp_pds14)
rownames(serp_pds14) <- serp_pds14$sample_num
rownames(timeseries2) <- timeseries2$sample_num
r.flow <- !rownames(timeseries2) %in% serp_pds14$sample_num
r.flow
rf.list.flow<-as.data.frame(timeseries2 [r.flow, ])
rf.list.flow$diff <- 0
rf.list.flow$stop <- 0
rf.list.flow$flowering <- 0
class(serp_pds14)
class(rf.list.flow)
serp_pds14_all<-rbind(as.data.frame(serp_pds14),rf.list.flow)
serp_pds14_all$flowering <- as.integer(serp_pds14_all$flowering)
str(serp_pds14_all$flowering)
str(serp_pds14_all$date.8.22.2018)

#survival analysis
S.flow <- Surv(
  #time = serp_pds14_all$start, 
  time = serp_pds14_all$stop, 
  event = serp_pds14_all$flowering)

model.flow<-survfit(S.flow~soil_let, data=serp_pds14_all)
model.flow
plot.fit.soil_let <- ggsurvplot((model.flow),data=serp_pds14_all, fun="event", conf.int = TRUE, censor=FALSE, legend.title = "Treatment", xlab = "Days to Flowering", ylab = "Overall Flowering Probability")
plot.fit.soil_let<-plot.fit.soil_let$plot + theme_bw()+facet_wrap(.~soil_let)
plot.fit.soil_let

serp_pds14_all$soil_stress = relevel(serp_pds14_all$soil_stress, ref = "S")
serp_pds14_all$microbe_type = relevel(serp_pds14_all$microbe_type, ref = "serpentine")
serp_pds14_all$soil_let <- droplevels(serp_pds14_all)$soil_let
model.cox_soil_let_14 <- coxph(S.flow~soil_let, data=serp_pds14_all)
model.cox_soil_let_14
ggforest(model.cox_soil_let_14, data=serp_pds14_all)
```
#System and session info
```{r}
Sys.info()
sessionInfo()
```
--- REVISED CODE WITH SEQUENCES RAREFIED TO EVEN DEPTH ---
#Load libraries
```{r}
library(phyloseq)
library(decontam)
library(dplyr)
library(RColorBrewer)
library(ggpubr)
library(vegan)
library(ggplot2)
library(lubridate)
library(lme4)
library(survival)
library(survminer)
library(DESeq2)
library(car)
library(emmeans)
library(viridis)
```
#Microbial Community Analysis
##Import data
```{r import data, include=FALSE}
otu <- readRDS("~/Desktop/R/serpnon_timeseries/input/serpnon_timeseries_otu_dada.rds")
tax <- readRDS("~/Desktop/R/serpnon_timeseries/input/serpnon_timeseries_silva.rds")
fitGTR <- readRDS("~/Desktop/R/serpnon_timeseries/input/seqtab.nochim_tree.RDS")
ps.metadata <- read.csv("~/Desktop/R/serpnon_timeseries/input/timeseries_metadata_phyloseq.csv",row.names=2)
```
##Create phyloseq objects
```{r otu table, include=FALSE}
OTU = otu_table(otu, taxa_are_rows=FALSE)
TAX = tax_table(as.matrix(tax))
TREE = phy_tree(fitGTR$tree)
META <- sample_data(ps.metadata)
ps = phyloseq(OTU, TAX, TREE, META)
ps
```
##Rarefaction curves by soil type (Supplemental Figures 1-6)
###A
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.A<- ps %>%
  subset_samples(
    soil_let == "A"
    )

timeseries.otu.A <- as(otu_table(ps.A), "matrix")
Rarecurve.A <- rarecurve((timeseries.otu.A), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
Rarecurve.A
```
###B
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.B<- ps %>%
  subset_samples(
    soil_let == "B"
    )

timeseries.otu.B <- as(otu_table(ps.B), "matrix")
Rarecurve.B <- rarecurve((timeseries.otu.B), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```
###C
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.C<- ps %>%
  subset_samples(
    soil_let == "C"
    )

timeseries.otu.C <- as(otu_table(ps.C), "matrix")
Rarecurve.C <- rarecurve((timeseries.otu.C), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```
###D
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.D<- ps %>%
  subset_samples(
    soil_let == "D"
    )

timeseries.otu.D <- as(otu_table(ps.D), "matrix")
Rarecurve.D <- rarecurve((timeseries.otu.D), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```
###E
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.E<- ps %>%
  subset_samples(
    soil_let == "E"
    )

timeseries.otu.E <- as(otu_table(ps.E), "matrix")
Rarecurve.E <- rarecurve((timeseries.otu.E), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```
###F
```{r, include=TRUE}
#rarefaction curve practice: http://www.fromthebottomoftheheap.net/2015/04/16/drawing-rarefaction-curves-with-custom-colours/
#below: plot rarefaction curve to check before rarefying
ps.F<- ps %>%
  subset_samples(
    soil_let == "F"
    )

timeseries.otu.F <- as(otu_table(ps.F), "matrix")
Rarecurve.F <- rarecurve((timeseries.otu.F), step = 100, xlab = "Reads", ylab = "Amplicon Sequence Variants (ASV)", label = TRUE)
```

##Remove mitochondria and chloroplast
```{r remove mitochondria, include=FALSE}
ps.bactsubset <- ps %>%
  subset_taxa(
    Kingdom == "Bacteria" &
    Family  != "Mitochondria" &
    Class   != "Chloroplast"
  )
ps.bactsubset
```
##Rarefy to even depth
```{r}
# rarefy without replacement
ps.bact <- rarefy_even_depth(ps.bactsubset, rngseed=1, sample.size=0.9*min(sample_sums(ps.bactsubset)), replace=F)
```

##Change taxa names to Seq #
```{r}
taxa_names(ps.bact) <- paste0("Seq", seq(ntaxa(ps.bact)))
dim(otu_table(ps.bact))
```
##Decontam
```{r}
ps.bact@sam_data$sample_or_control<-ps.bact@sam_data$soil_let
ps.bact@sam_data$sample_or_control<-as.character(ps.bact@sam_data$sample_or_control)
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="A"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="B"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="C"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="D"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="E"]<-"sample"
#ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="F"]<-"sample"
ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control!="CON"]<-"sample"
ps.bact@sam_data$sample_or_control[ps.bact@sam_data$sample_or_control=="CON"]<-"control"
ps.bact@sam_data$sample_or_control<-as.factor(ps.bact@sam_data$sample_or_control)
ps.bact@sam_data$sample_or_control
```
```{r}
df <- as.data.frame(sample_data(ps.bact)) # Put sample_data into a ggplot-friendly data.frame
df$LibrarySize <- sample_sums(ps.bact)
df <- df[order(df$LibrarySize),]
df$Index <- seq(nrow(df))
ggplot(data=df, aes(x=Index, y=LibrarySize, color=sample_or_control)) + geom_point()
```
```{r}
sample_data(ps.bact)$is.neg <- sample_data(ps.bact)$sample_or_control == "control"
contamdf.prev <- isContaminant(ps.bact, method="prevalence", neg="is.neg", threshold = 0.025, batch=ps.bact@sam_data$date.dna)
table(contamdf.prev$contaminant)
head(which(contamdf.prev$contaminant))
contamdf.prev_decontam <- subset(contamdf.prev, contamdf.prev$contaminant=="FALSE")
ps.bact.decontam <- subset_taxa(ps.bact, taxa_names(ps.bact)%in%rownames(contamdf.prev_decontam))
ps.bact.decontam
contamdf.prev_contam <- subset(contamdf.prev, contamdf.prev$contaminant=="TRUE")
ps.bact.contam <- subset_taxa(ps.bact, taxa_names(ps.bact)%in%rownames(contamdf.prev_contam))
ps.bact.contam
```
```{r}
# Make phyloseq object of presence-absence in negative controls and true samples
ps.bact.pa <- transform_sample_counts(ps.bact, function(abund) 1*(abund>0))
ps.bact.pa.neg <- prune_samples(sample_data(ps.bact.pa)$sample_or_control == "control", ps.bact.pa)
ps.bact.pa.pos <- prune_samples(sample_data(ps.bact.pa)$sample_or_control == "sample", ps.bact.pa)
# Make data.frame of prevalence in positive and negative samples
df.pa <- data.frame(pa.pos=taxa_sums(ps.bact.pa.pos), pa.neg=taxa_sums(ps.bact.pa.neg),
                      contaminant=contamdf.prev$contaminant)
ggplot(data=df.pa, aes(x=pa.neg, y=pa.pos, color=contaminant)) + geom_point() +
  xlab("Prevalence (Negative Controls)") + ylab("Prevalence (True Samples)")
```
##Normalize sequences for bray-curtis
```{r}
#for bray-curtis
ps.bact.decontam_prop <- transform_sample_counts(ps.bact.decontam, function(x) x/sum(x))
ps.bact.decontam_prop <- subset_taxa(ps.bact.decontam_prop,taxa_sums(ps.bact.decontam_prop)>0)
ps.bact.decontam_prop
dim(otu_table(ps.bact.decontam_prop))
```
##labels
```{r}
microbe_labels <- c("nonserpentine"="NS Microbes", "serpentine"="S Microbes")
soil_let_labels <- c("A"="S+Sm", "B"="NS+NSm", "C"="S+NSm", "D"="NS+Sm", "E"="NS+Sm+Ni", "F"="NS+Sm+Drought")
```
##Subset samples
###A-F soil types
```{r, include=FALSE}
ps.bact.decontam.af <- ps.bact.decontam %>%
  subset_samples(
    soil_let == "A" |
    soil_let == "B" |
    soil_let == "C" |
    soil_let == "D" |
    soil_let == "E" |
    soil_let == "F" |
    soil_let != "CON")

ps.bact.decontam.af <- ps.bact.decontam.af %>%
  subset_samples(
    pds=="0" |
    pds=="1" |
    pds=="2" |
    pds=="3" |
    pds=="4" )

ps.bact.decontam.af
```
```{r}
ps.bact.decontam.af_prop <- ps.bact.decontam_prop %>%
  subset_samples(
    soil_let == "A" |
    soil_let == "B" |
    soil_let == "C" |
    soil_let == "D" |
    soil_let == "E" |
    soil_let == "F" |
    soil_let != "CON")

ps.bact.decontam.af_prop <- ps.bact.decontam.af_prop %>%
  subset_samples(
    pds=="0" |
    pds=="1" |
    pds=="2" |
    pds=="3" |
    pds=="4" )

ps.bact.decontam.af_prop
```
##Figure 1
###What is the relative abundance of each phylum within the different samples?
```{r}
#wrangle data
ps.bact.decontam_phylum <- ps.bact.decontam.af %>%
  tax_glom(taxrank = "Phylum") %>%                     # agglomerate at phylum level
 transform_sample_counts(function(x) {x/sum(x)} ) %>% # Transform to rel. abundance
  psmelt() %>%                                         # Melt to long format
  filter(Abundance > 0.02) %>%                         # Filter out low abundance taxa
  arrange(Phylum)
ps.bact.decontam_phylum
```
```{r}
#abundance table
sd_phylum <- ps.bact.decontam_phylum %>% group_by(soil_stress,microbe_type,pds,Phylum) %>% dplyr::summarise(mean(Abundance, na.rm = TRUE))
sd_phylum
```
###What is the alpha diversity?
```{r}
#table of richness
sg.richness <- estimate_richness(ps.bact.decontam.af, measures=c("Shannon"))
sg.richness$Shannon
sg.richness$ID <- row.names(sg.richness)
View(sg.richness)
timeseries.af.df <- as(sample_data(ps.bact.decontam.af), "data.frame")
timeseries.af.df$ID <- row.names(timeseries.af.df)
timeseries.df.richness <- merge(timeseries.af.df,sg.richness,by="ID")
row.names(timeseries.df.richness)<-timeseries.df.richness$ID

#abundance table
sd_richness <- timeseries.df.richness %>% group_by(soil_stress,microbe_type,pds) %>% dplyr::summarise(mean(Shannon, na.rm = TRUE))
sd_richness
```
```{r}
#statistical analysis of shannon
field.fit.shannon <- lm(estimate_richness(ps.bact.decontam.af)$Shannon ~ soil_stress*microbe_type*pds+tray, data=as(sample_data(ps.bact.decontam.af), "data.frame"))
summary(aov(field.fit.shannon))
TukeyHSD(aov(field.fit.shannon))
```
###Figure 1 - relative abundance + richness
```{r}
ps.bact.decontam_phylum$soil_stress_new<-factor(ps.bact.decontam_phylum$soil_stress, levels=c("S","NS","NS+Drought","NS+Ni"))

ps.bact.decontam.af@sam_data$soil_stress_new<-factor(ps.bact.decontam.af@sam_data$soil_stress, levels=c("S","NS","NS+Drought","NS+Ni"))

# Define the number of colors you want
nb.cols <- length(unique(ps.bact.decontam_phylum$Phylum))
mycolors <- colorRampPalette(brewer.pal(11, "Spectral"))(nb.cols)

ps.bact.decontam_phylum_bar<-ggplot(ps.bact.decontam_phylum, aes(x = pds, y = Abundance, fill = Phylum)) + theme_bw() + facet_grid(microbe_type~soil_stress_new, labeller=labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering")) +
  geom_bar(stat="identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  #fill=mycolors(nb.cols) +
  scale_fill_manual(values=mycolors) +
  theme(text = element_text(size=16)) +
  ylab ("Relateve Abundance (Phyla > 2%)") +
  xlab ("Plant Developmental Phase") +
  theme(legend.position="bottom",
        axis.text.x = element_text(angle=90, hjust=0.5, vjust=0.5)) +
  guides(fill=guide_legend(legend.position="bottom", nrow=4))

sg_richness_plot <- plot_richness(ps.bact.decontam.af, x="pds", measures=c("Shannon")) +  theme_bw() + 
  facet_grid(microbe_type~soil_stress_new, labeller=labeller(microbe_type = microbe_labels)) +
  scale_x_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering")) +
  geom_boxplot() +
  xlab ("Plant Developmental Phase") +
  scale_color_viridis(discrete=TRUE, option="inferno") + 
  theme(text = element_text(size=16), axis.text.x = element_text(angle=90, hjust=1, vjust=0.9), legend.title=element_blank())
sg_richness_plot$layers <- sg_richness_plot$layers[-1]

fig.1<-ggarrange(ps.bact.decontam_phylum_bar,sg_richness_plot, labels="auto", nrow=1,  widths = c(1.25, 1))
fig.1
#ggsave("/Users/anigwe/Desktop/strep_figures/figure1.tiff", height=180, width=350, units='mm', dpi=200)
```
##Figure 2
###What is the beta diversity? - bray
```{r}
#stats bray
serpnon.timeseries.af_bray <- phyloseq::distance(ps.bact.decontam.af_prop, method="bray")
#summary(strep.bray)
sampledf.strep <- data.frame(sample_data(ps.bact.decontam.af_prop))
adonis.serpnon.timeseries.af.bray <- adonis(serpnon.timeseries.af_bray ~ soil_stress*microbe_type*pds+tray, data = sampledf.strep)
adonis.serpnon.timeseries.af.bray
#betadisper
beta.serpnon.timeseries.af.bray_sc <- betadisper(serpnon.timeseries.af_bray, sampledf.strep$soil_stress, type="centroid")
permutest(beta.serpnon.timeseries.af.bray_sc)
boxplot(beta.serpnon.timeseries.af.bray_sc)
TukeyHSD(beta.serpnon.timeseries.af.bray_sc)

beta.serpnon.timeseries.af.bray <- betadisper(serpnon.timeseries.af_bray, sampledf.strep$pds, type="centroid")
permutest(beta.serpnon.timeseries.af.bray)
boxplot(beta.serpnon.timeseries.af.bray)
TukeyHSD(beta.serpnon.timeseries.af.bray)

beta.serpnon.timeseries.af.bray_ms <- betadisper(serpnon.timeseries.af_bray, sampledf.strep$microbe_type, type="centroid")
permutest(beta.serpnon.timeseries.af.bray_ms)
boxplot(beta.serpnon.timeseries.af.bray_ms)
TukeyHSD(beta.serpnon.timeseries.af.bray_ms)
```
###Figure 2 - Bray-Curtis Dissimilarity
```{r}
ps.bact.decontam.af_prop@sam_data$soil_stress_new<-factor(ps.bact.decontam.af_prop@sam_data$soil_stress, levels=c("S","NS","NS+Drought","NS+Ni"))
#ordination
ord.pcoa.bray <- ordinate(ps.bact.decontam.af_prop, method="PCoA", distance="bray")
#Figure 4
bg.facet <-plot_ordination(ps.bact.decontam.af_prop, ord.pcoa.bray, color="pds") +
  scale_color_discrete(labels = c("0"="Initial", "1"="Seedling", "2"="Vegetative", "3"="Early Flowering", "4"="Late Flowering")) +
  #scale_color_manual(breaks=c("A","B","C","D","E","F"),
                    # values=c("#E69F00","#56B4E9","#009E73","#F0E442","#0072B2","#D55E00"), labels=soil_let_labels) +
  facet_grid(microbe_type~soil_stress_new, labeller=labeller(microbe_type = microbe_labels)) +
  theme_bw() + theme(text = element_text(size=20)) +
  geom_point(size=5)+
  theme(legend.text = element_text(size = 20)) + 
  guides(color=guide_legend(title="Plant Developmental Phase")) 
  #labs(title="PCoA of Bray-Curtis Dissimilarity")
#+ scale_color_viridis(option="inferno")
bg.facet
#ggsave("/Users/anigwe/Desktop/feature_image_test.png", height=223, width=400, units='mm', dpi=400)
```
##Figure 5, Supplemental Figure 7, Supplemental Figure 8
###Are there differentially abundant microbes? - random forest?
```{r}
#ps.bact.decontam.af_phyla<-tax_glom(ps.bact.decontam.af, "Phylum")
#ps.bact.decontam.af_family<-tax_glom(ps.bact.decontam.af, "Family")
#ps.bact.decontam.af_genus<-tax_glom(ps.bact.decontam.af, "Genus")
#ps.bact.decontam.af_asv<-ps.bact.decontam.af
```
```{r}
ps.bact.decontam.af.4 <- ps.bact.decontam.af %>%
  subset_samples(
    pds=="4")

ps.bact.decontam.af.4

ps.bact.decontam.ad <- ps.bact.decontam %>%
  subset_samples(
    soil_let == "A" |
    soil_let == "B" |
    soil_let == "C" |
    soil_let == "D" )

ps.bact.decontam.ad <- ps.bact.decontam.ad %>%
  subset_samples(pds!="5")

ps.bact.decontam.ad
```
```{r}
library(randomForest)
library(ggplot2)
library(phyloseq)
library(knitr)

# Make a dataframe with OTUs as column and samples as rows
predictors <- otu_table(ps.bact.decontam.af_prop)

# Make one column for our outcome/response variable 
response <- as.factor(sample_data(ps.bact.decontam.af_prop)$soil_let)

# Combine them into 1 data frame
rf.data <- data.frame(response, predictors)

#set seed and run random forest
set.seed(2)
erie.classify <- randomForest(response~., data = rf.data, ntree = 999)

#determine OOB estimate of error rate; rerun randomForest and increase ntree if OOB is too high
print(erie.classify)

# Make a data frame with predictor names and their importance
imp <- importance(erie.classify)
imp <- data.frame(predictors = rownames(imp), imp)

# Order the predictor levels by importance
imp.sort <- arrange(imp, desc(MeanDecreaseGini))
imp.sort$predictors <- factor(imp.sort$predictors, levels = imp.sort$predictors)

# Select the top 20 predictors
imp.20 <- imp.sort[1:20, ]

# visualize top 20 predictors
ggplot(imp.20, aes(x = predictors, y = MeanDecreaseGini)) +
  geom_bar(stat = "identity", fill = "indianred") +
  coord_flip() +
  ggtitle("Most important OTUs for classifying soil samples\n into serpentine or nonserpentine")
  
# Create a table of OTUs
otunames <- imp.20$predictors
r <- rownames(tax_table(ps.bact.decontam.af_prop)) %in% otunames
kable(tax_table(ps.bact.decontam.af_prop)[r, ])

#subset top 20 OTUs for plotting
eerie <- subset_taxa(ps.bact.decontam.af_prop, taxa_names(ps.bact.decontam.af_prop) %in% otunames)
plot_bar(eerie)

#convert phyloseq object to data frame for visualization and data manipulation
eerie.df <- psmelt(eerie)

#log transform abundances for visualization
eerie.df$LogAbund <- log10(eerie.df$Abundance +1)

#visualize abundances
subset.eerie <- ggplot(eerie.df, aes(x=pds, y=LogAbund, fill=soil_let)) +
facet_wrap(Genus~OTU~Phylum, scale="free") +
  #scale_x_discrete(position="top") + coord_flip() +
  stat_summary(fun = mean, geom = "bar", color="black", position = "dodge") + 
  stat_summary(fun.data = mean_se, geom = "errorbar", position = "dodge") +
  #expand_limits(y=c(0,2)) +
  theme_classic() +
  guides(fill=FALSE) +
  #scale_y_continuous(trans='log10+1')+
  #facet_wrap(~soil, scales="free") +
  theme(text = element_text(size=9), axis.text.x = element_text(angle = 45, hjust = 1), plot.title = element_text(hjust=0.0)) + labs(title="Differential taxa", subtitle="by soil type") + scale_x_discrete(labels=c("." = "Bulk", "Collinsia" = "C. sparsiflora",
                              "Gilia" = "G. tricolor", "Plantago" = "P. erecta", "Trifolium" = "T. fucatum"))
subset.eerie
```

